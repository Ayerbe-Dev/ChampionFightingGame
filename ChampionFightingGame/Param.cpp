#include "Param.h"
#include "Prmlst.h"

Param::Param() {
    name = "";
    type = -1;
}

Param::Param(std::string name) {
    this->name = name;
}

ParamTable::ParamTable() {
    load_fail = false;
}

ParamTable::ParamTable(std::string resource_dir) {
    load_fail = false;
    load_params(resource_dir);
}

void ParamTable::load_params(std::string resource_dir) {
    load_fail = false;
    std::ifstream param_file;
    param_file.open(resource_dir, std::ios::binary);

    if (param_file.fail()) {
        param_file.close();
        std::cout << "Failed to open param file: " << resource_dir << "\n";
        load_fail = true;
        return;
    }

    for (int i = 0; !param_file.eof(); i++) {
        Param param;
        parse_param_entry(param_file, param.name, param.type, param.value);
        if (i != 0 || !param_file.eof()) {
            add_param(param, i);
        }
    }
    param_file.close();
}

void ParamTable::add_param(Param param, int index) {
    params.push_back(param);
    param_map[param.name] = index;
}

void ParamTable::unload_params() {
    params.clear();
}

int ParamTable::get_param_int(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return 0;
    }
    if (params[param_map[param_name]].value.type() != typeid(int)) {
        std::cout << "Param " << param_name << " is not of type int\n";
        return 0;
    }
    return std::any_cast<int>(params[param_map[param_name]].value);
}

int ParamTable::get_param_int(std::string param_name, std::string sub_table_name) {
    return get_param_table(sub_table_name).get_param_int(param_name);
}

int ParamTable::get_param_int(std::string param_name, int sub_table_index) {
    return get_param_table(sub_table_index).get_param_int(param_name);
}

int ParamTable::get_param_int(std::string param_name, std::initializer_list<std::any> sub_tables) {
    std::list<std::any> list(sub_tables);
    return get_param_int(param_name, list);
}

int ParamTable::get_param_int(std::string param_name, std::list<std::any> sub_tables) {
    std::any front = sub_tables.front();
    sub_tables.pop_front();
    if (front.type() == typeid(int)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<int>(front)).get_param_int(param_name);
        }
        else {
            return get_param_table(std::any_cast<int>(front)).get_param_int(param_name, sub_tables);
        }
    }
    else if (front.type() == typeid(std::string)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<std::string>(front)).get_param_int(param_name);
        }
        else {
            return get_param_table(std::any_cast<std::string>(front)).get_param_int(param_name, sub_tables);
        }
    }
    else {
        std::cout << "ERROR: Initializer list passed to get_param_int(" << param_name << ") contained a value which was neither int nor string.\n";
        return 0;
    }
}

float ParamTable::get_param_float(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return 0.0;
    }
    if (params[param_map[param_name]].value.type() != typeid(float)) {
        std::cout << "Param " << param_name << " is not of type float\n";
        return 0.0;
    }
    return std::any_cast<float>(params[param_map[param_name]].value);
}

float ParamTable::get_param_float(std::string param_name, std::string sub_table_name) {
    return get_param_table(sub_table_name).get_param_float(param_name);
}

float ParamTable::get_param_float(std::string param_name, int sub_table_index) {
    return get_param_table(sub_table_index).get_param_float(param_name);
}

float ParamTable::get_param_float(std::string param_name, std::initializer_list<std::any> sub_tables) {
    std::list<std::any> list(sub_tables);
    return get_param_float(param_name, list);
}

float ParamTable::get_param_float(std::string param_name, std::list<std::any> sub_tables) {
    std::any front = sub_tables.front();
    sub_tables.pop_front();
    if (front.type() == typeid(int)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<int>(front)).get_param_float(param_name);
        }
        else {
            return get_param_table(std::any_cast<int>(front)).get_param_float(param_name, sub_tables);
        }
    }
    else if (front.type() == typeid(std::string)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<std::string>(front)).get_param_float(param_name);
        }
        else {
            return get_param_table(std::any_cast<std::string>(front)).get_param_float(param_name, sub_tables);
        }
    }
    else {
        std::cout << "ERROR: Initializer list passed to get_param_float(" << param_name << ") contained a value which was neither int nor string.\n";
        return 0.0f;
    }
}

std::string ParamTable::get_param_string(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return "";
    }
    if (params[param_map[param_name]].value.type() != typeid(std::string)) {
        std::cout << "Param " << param_name << " is not of type string\n";
        return "";
    }
    return std::any_cast<std::string>(params[param_map[param_name]].value);
}

std::string ParamTable::get_param_string(std::string param_name, std::string sub_table_name) {
    return get_param_table(sub_table_name).get_param_string(param_name);
}

std::string ParamTable::get_param_string(std::string param_name, int sub_table_index) {
    return get_param_table(sub_table_index).get_param_string(param_name);
}

std::string ParamTable::get_param_string(std::string param_name, std::initializer_list<std::any> sub_tables) {
    std::list<std::any> list(sub_tables);
    return get_param_string(param_name, list);
}

std::string ParamTable::get_param_string(std::string param_name, std::list<std::any> sub_tables) {
    std::any front = sub_tables.front();
    sub_tables.pop_front();
    if (front.type() == typeid(int)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<int>(front)).get_param_string(param_name);
        }
        else {
            return get_param_table(std::any_cast<int>(front)).get_param_string(param_name, sub_tables);
        }
    }
    else if (front.type() == typeid(std::string)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<std::string>(front)).get_param_string(param_name);
        }
        else {
            return get_param_table(std::any_cast<std::string>(front)).get_param_string(param_name, sub_tables);
        }
    }
    else {
        std::cout << "ERROR: Initializer list passed to get_param_string(" << param_name << ") contained a value which was neither int nor string.\n";
        return "";
    }
}

bool ParamTable::get_param_bool(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return false;
    }
    if (params[param_map[param_name]].value.type() != typeid(bool)) {
        std::cout << "Param " << param_name << " is not of type bool\n";
        return false;
    }
    return std::any_cast<bool>(params[param_map[param_name]].value);
}

bool ParamTable::get_param_bool(std::string param_name, std::string sub_table_name) {
    return get_param_table(sub_table_name).get_param_bool(param_name);
}

bool ParamTable::get_param_bool(std::string param_name, int sub_table_index) {
    return get_param_table(sub_table_index).get_param_bool(param_name);
}

bool ParamTable::get_param_bool(std::string param_name, std::initializer_list<std::any> sub_tables) {
    std::list<std::any> list(sub_tables);
    return get_param_bool(param_name, list);
}

bool ParamTable::get_param_bool(std::string param_name, std::list<std::any> sub_tables) {
    std::any front = sub_tables.front();
    sub_tables.pop_front();
    if (front.type() == typeid(int)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<int>(front)).get_param_bool(param_name);
        }
        else {
            return get_param_table(std::any_cast<int>(front)).get_param_bool(param_name, sub_tables);
        }
    }
    else if (front.type() == typeid(std::string)) {
        if (sub_tables.empty()) {
            return get_param_table(std::any_cast<std::string>(front)).get_param_bool(param_name);
        }
        else {
            return get_param_table(std::any_cast<std::string>(front)).get_param_bool(param_name, sub_tables);
        }
    }
    else {
        std::cout << "ERROR: Initializer list passed to get_param_bool(" << param_name << ") contained a value which was neither int nor string.\n";
        return false;
    }
}

ParamTable ParamTable::get_param_table(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return ParamTable();
    }
    if (params[param_map[param_name]].value.type() != typeid(ParamTable)) {
        std::cout << "Param " << param_name << " is not of type param table\n";
        return ParamTable();
    }
    return std::any_cast<ParamTable>(params[param_map[param_name]].value);
}

ParamTable ParamTable::get_param_table(int param_index) {
    if (params.size() <= param_index) {
        std::cout << "Param Index " << param_index << "is out of range\n";
        return ParamTable();
    }
    if (params[param_index].value.type() != typeid(ParamTable)) {
        std::cout << "Param Index " << param_index << " is not of type param table\n";
        return ParamTable();
    }
    return std::any_cast<ParamTable>(params[param_index].value);
}

int ParamTable::get_param_type(std::string param_name) {
    if (!param_map.contains(param_name)) {
        std::cout << "Failed to find param " << param_name << "\n";
        return 0;
    }
    return params[param_map[param_name]].type;
}

bool ParamTable::load_failed() {
    return load_fail;
}

/*
  "n/((|()n/((1Y1()rf(((1|I(((xu((v/j^  ]c,  x)(((|u[^f|' 't|/)(()x|((((]f(((1[~{()z/()z)(((((J)()(iv>  !z+!t(((1[+)((J"|)()Q(((vt((|((v~                     
                     r" .p[  rl  .L  'd"    |~l  ))  c~  _. .m..Q.  i  ,p   1  :d'   x'   >C^    t}'  i1  nl;  'lz'  /[  "i  )X"    /1"  0:r  'd? .q' lp+  u                     
                     v^ 'YX  -:   }  >O  :  )[l  /)  c<  +YYr( .Q. 'd  'L   m  '*'   1    >w  +  v('  .!  Y;w  i}x'  j;  ~[  lL. I  t/^  0:r  .ZY` l .U][  v                     
                     v^ 'vL. ;' ' l  {c  }  ivl      un-   `/< .Q.    ;0j   m  '#' .'. i  >r  X  +X'   .  Y;w  i}x'  f,  <xvc/j  }  [Y^  0:r  .Ol|   <>_[  v                     
                     v^ 'nf, ' "+ '  cx  ?' 'd!  |)  vruYx   u".Q. 'd  `L   m  '*' ^!  m  >t  |. 'b' ".   Y;w  i}x'  j:  ~]  ;n  (' `d"  O:r  .O.r. .Y._[  v                     
                     n" `z-I   +X    Y)      z!  ()  c}  r!  ),.Q. .p  .h   w  `h' "_ .k  <_      Q' ^d   Y;w  i}x'  t+  i} .-+      d"  trv  .zt0. .z.}}  u                     
                     <|  'Z~   tc.  .L^  x~  ~!  11  xv^    >r..Y. .q  .vz    .vY' "j ^h  >`  vi  1. `m!  U1q  itn'  [n!    lq`  v~  1^    (    'w. .u]i  lf                     
                                                        ^;;`              ',I,. .             . '+mB@%&#akkkkkkkha*&B@@&c-l^                                                     
                                                                                            :rWMkkkkkkkkkkkkkkkkkkkkkkkkka&B&j;                                                  
                                                                                        `}*8akkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkhM%8r,                                              
                                                                                      }#&hkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkka&8(.                                           
                                                                                   .X%okkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk*%Y`                                         
                                                                                 ,q8akkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkka%r                                        
                                                                               _M#kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkqCct|1/cmkkkkkkkkkk*o`                                      
                                                                        :LMMhd*kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkq~.             :Qkkkkkkk#w                                      
                                                                     {B&kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkb{       `llI;"'.    :pkkkkkk&u                                     
                                                                  .j8kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkX.        c<>>>><<1;   .Okkkkko#                                     
                                                                 >WhkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkX         'v<>>><<<)`    <kkkkkk@,                                    
                                                                ;&bkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk(         ^j>><r;i>"     .wkkkkh@,                                    
                                                               `8akkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk/         i-<<<1          CkkkkaB.                                    
                                                               j&kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkU         )<>>[;         .Zkkkk#w                                     
                                                               r8kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk_        -n}?v          "bkkkk8U                                     
                                                                ^CB*kkkkkkkkkkkkkkkkkkkkkkkkkkha*M&8%BB@@@@BB8&#hZv-`               [kkkha%"                                     
                                                                  I8Qo%@@%M#ooahahhh*WB@%&MokkkkkkkkkkkkkkkkkkkkkkkkkaW%B@@O?,.    'qkkka@}                                      
                                                                  LCUYYYYYYYYUYJBJYUm%akkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkaM%BMQahkkk%u                                       
                                                                 -hYYYYYYYYYYYUw%YYUYU0M%*kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkh#&B@d                                        
                                                                'aCYYYYYUYYYYYYkpYYYYYYU%*Z&8#akkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk*m.                                      
                                                                1wYYYYYq*#pCYUU8LYYYYYUa@}???)d@@@%%8&&&88%%%888&&WWM#*ohkkkkkkkkkkkkkkkkB[                                      
                                                               l%JUYYYZ8[)[|CMh@UYYYYYJ%w???????????1q@@@@@q[???????]{|tnCb%B8MakkkkkkkkkWY                                      
                                                               QQYUYYZ&}??O{??x&YYYYYYO@j???????????-?]Q@@@@@8O[??????????????}|C#B%Makkh@-                                      
                                                              /oYYYYYWt????O??Q*YYYYYYd8?????????????????tW@@@@@@%w{????????????????]u@wh"                                       
                                                             'MCUYYUpb??????n?L*YYYYYYJ&#(??????????-??]???????[Co%B@@@@Mt???????????Qr.                                         
                                                            .qwUYYYU&v]a{????#r#UYYYYYYUUq@]????????????)uZdt[???????????????????????#>                                          
                                                            ]%UYYYYL%?)X???1U]?tb&#dZLLOkBC?????}ndddp0zx/[?[nn[???????????????JBu??[8^                                          
                                                           .#UYYUYY0Z?/1?]Y)????????tvvj[??????????dt  ]j/L&Bdv]?????????????]r[q@@@%*`                                          
                                                           JdYYYYYYox?)1?{1????????????Oc??????????_)urr+qq!JhUt????????????[|???}Q%@@&"                                         
                                                          "oUYYYYYY@/??O]?)(???????????]M|????????????-___)jn<???????????]?|k(??????[M8"                                         
                                                         `BCYYYYYYYB/??]QC?U????????Q???c&}???????????????????????????????{c?[np]??)8O.                                          
                                                         rCYYYYYYYYU&d???]JqY]???????c???&Q??????????????????????????????]p8ht????c@[                                            
                                                        -aYYYYYYYYYYUb@b]??m*????????tx??f@{?????????????????????????????q{:/^h@Zao'                                             
                                                       .hYYYYYYYYYYYYUJ&@d[%f?????????x1?[WQ]???????????????????????????(b_{OQY_?B!                                              
                                                      .*OYYYYYYYYYYYYYYYQ&@L???????????b??L@{???????????????????????????c}??????f@^     `"                                       
                                                      /dUYYYYYYYYYYYYYYYYZ@{???????????[C?}@h?????????????????????[)|//|C???????L*     +L                                        
                                                     (#UYYYYYYYYYYYYYYYYJ@|?????????????Y(?h%{??????????????????](/////|Z???????dU    }J                                         
                                                   !#OUYYYYYYYYYYYYYYYYYhk??????????????Yt?Q@c?????????????????]||/////t0???????at   +h'                                         
                                                `X&mYYYYYYYUYYYYYYYJLZd&%]??????????????L??n@@]?????????????}|/|///////Cu??????[M<  ?a'                                          
                                              ?BBpUYYYUYYUJOkW%@@80j1[[Mz???????????????h???@@c????????????1///////////q)??????)B' ,W^                                           
                                                  jorCZZ0v)???????????zM??????????????]]Q???@@Q]???????????}//t////////p]?????1%C I8}                                            
                                                 <W??????????????????r%{???????????????rC???L#&%@@@$@@&od0zj|[??)b/|///}????]k#! '#v                                             
                                                !8t??????????????????#Z????????????????bj??????????][)jzLwdhap]??](/U0[????U%>   Qh'                                             
                                               iBt??????????????????m*?????????????????*?????????cmu)]???????????????r@%dUkaf   zBl                                              
                                              ,&v??????????????]W[?)%x????????????????]b??????????]xCUvttftjrnYC]??????}rW&@BoUrBY                                               
                                             :&X???????????????]%|[BZ?????????????????}u????????????]|Ql_rqpY1??jdqqQ???jL&( "~)z;                                               
                                            <Bx?????????????????pt/%(?????????????????1(???????????????1Ji   'I0(?)|tJ??Zoq                                                      
                                           _B/??????????????????|O?[MX]???????????????????????????????????]np?  ''.L|[?CzB<                                                      
                                          [B|???????????????????}W???0*]?????????????????????????????{]???????????1]?]?npp                                                       
                                         cW}?????????????????????an???/Bt??????????????????????????????Xz{????????????Z/W'                                                       
                                       .bm???????????????????????YL????]oO????????????????????????????????jZLr/){]?????pr                                                        
                                      <@r????????????????????????[#??????J#{??????????????????????????????????????????rb                                                         
                                     ua]??????????????????????????d???????{Mx????????????????????????????????????????(Bi                                                         
                                   ,oz????????????????????????????Cq???????]0d???????????????????????????????????????a[                                                          
                                'rWb[?????????????????????????????|#]????????)W)????????????????????????????????????QZ                                                           
                             "wBh{????????????????????????????????]%(????????]]qm??????????????????????????????????]8'                                                           
                        .;YB&X]????????????????????????????????????Xr??????????-1B1???????????????????????????????}%?                                                            
                   ^izWWpr?????????????????????????????????????????|o????????????]pd]?????????????????????????????wx                                                             
              :[L#dz}??????????????????????????????????????????????[W}?????????????)8X???????????????????????????Up                                                              
          ?QpY(????????????????????????????????????????????????????]hX???????????????C%r????????????????????????]&"                                                              
          "-????????????????????????????????????????????????????????jO????????????????[q8u??????????????v??????[W{                                                               
            !????????????????????????????????????????????????????????W??????????????????}Y%hr??????????L???????QY                                                                
              :-?????????????????????????????????????????????????????m)????????????????????](O8&*Ov{??[{??????ca'                                                                
                .i???????????????????????????????????????????????????Ch??????????????????????????]}r0M@@B%8*hq%,                                                                 
                   '~????????????????????????????????????????????????[%{??????????????????????????????]b%"                                                                       
                      .;+?????????????????????????????????????????????rY?????????????????????????????}o]M"                                                                       
                          .;~?????????????????????????????????????????[&1???????????????????????????{0??*`                                                                       
                               ,>-?????????????????????????????????????/Q??????????????????????????{z???#'                                                                       
                                   `l+??????????????????????????????????Oj????????????????????????ru????Bm.                                                                      
                                       ."i???????????????????????????????b[??????????????????????Qr????LpYa`                                                                     
                                            ',~??????????????????????????{k????????????????????]o|?????bZ?{x                                                                     
                                                 ';-????????????????????????????????????????????????????????>                                                                    
*/